<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/styles.css">
    <title>Profile</title>
    <script>
        document.addEventListener('DOMContentLoaded', ()=>{
            const joinClubBtn = document.getElementById("joinClubBtn");
            const dialog = document.getElementById("clubMemberCredentialDialog")
            const submitBtn = document.getElementById("submitCredentialsBtn");
            const cancelBtn = document.getElementById("cancelCredentialsBtn");
        
            joinClubBtn.addEventListener('click', (e)=>{
                dialog.showModal();
            })
        
            submitBtn.addEventListener('click', async (e)=>{
                e.preventDefault();
                const form = document.getElementById("credentialsForm");
                if (form.secret_passcode.value===''){
                    alert('Please enter the secret passcode!');
                    return;
                }
                try {
                    // Make POST request to your auth endpoint
                    const res = await fetch(form.action, {
                    method: "POST",
                    headers: {'Content-Type': "application/json"},
                    body: JSON.stringify({
                        secret_passcode: form.secret_passcode.value,
                    }),
                    });
                  
                    if (res.ok) {
                        alert("Welcome to the club!");
                        dialog.close();
                        window.location.href = '/profile'
                        return;
                    } else {
                        alert("Wrong passcode!");
                        return;
                    }
                } catch (error) {
                    console.log('Error while submitting the club member passcode: ', error);
                }
             
            })
            
            cancelBtn.addEventListener('click', (e)=>{
                e.preventDefault();
                dialog.close()
            })
        })
    </script>
  </head>
  <body>
    <%- include('header') %>
    <div class="wrapper">
        <dialog id="clubMemberCredentialDialog">
            <form id="credentialsForm" method="post" action="/profile?_method=PUT">
                <h4>Secret passcode Required!</h4>
                <p>Please enter the secret passcode to become a club member. Being a club member allows you to view the author of the posts.</p>

                <input id="secret_passcode"  type="password" name="secret_passcode" placeholder="Enter the passcode" required/>
                <% if (errors.secret_passcode) {%>
                    <div class="error"><%= errors.secret_passcode.msg %></div>
                <% } %>
                <div class="dialogBtnWrapper">
                    <button id="cancelCredentialsBtn">Cancel</button>
                    <button id="submitCredentialsBtn">Submit</button>
                </div>
            </form>
        </dialog>
        <a href="/log-out">
          <button class="logoutBtn">Logout</button>
        </a>
        <div>

            <h3>Your Info</h3>
            <p>Name: <%= user.first_name %> <%= user.last_name %></p>
            <p>Username:  <%= user.username %></p>
            <% if (user.is_club_member) { %>
                <p>Club Member</p>
              <% } else { %>
               You are not a member.  <button id="joinClubBtn">Join the club</button>
              <% } %>
              
        </div>
        <h3>Posts</h3>
        <div class="postCount">
            You have <strong><%= totalPosts %></strong>  <%= totalPosts <=1 ? "post" : "posts" %>.
        </div>
        <% userPosts.forEach((post, index)=> { %>
            <% const {post_id, post_title, post_text, post_image, user_id, created_at, updated_at, first_name, last_name} = post %>
            <div class="message">
                <div class="avatarContainer">
                    <div class="nameAndDateContainer">
                        <p class="date"><%= getDayAndTime(created_at)  %></p>
                    </div>
                </div>
               <div class="profileTextContainer">
                   <p class="title"><%= post_title %></p>
                   <p class="text"><%= post_text %></p>
               </div>
            </div>
       <% }) %>
    </div>
  </body>
</html>
